<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Drafting Assistant</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for better aesthetics and responsiveness */
        .module-container {
            background-color: #ffffff;
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            padding: 1.5rem; /* p-6 */
        }
        .input-group {
            margin-bottom: 1.5rem; /* mb-6 */
        }
        .label-text {
            display: block;
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            color: #374151; /* text-gray-700 */
            margin-bottom: 0.25rem; /* mb-1 */
        }
        .input-field, .textarea-field, .select-field {
            width: 100%;
            padding: 0.5rem 1rem; /* px-4 py-2 */
            border: 1px solid #d1d5db; /* border border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            transition: all 0.2s ease-in-out; /* transition-colors duration-200 */
        }
        .input-field:focus, .textarea-field:focus, .select-field:focus {
            outline: none;
            border-color: #3b82f6; /* focus:border-blue-500 */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); /* focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 */
        }
        .button-primary {
            width: 100%;
            padding: 0.75rem 1.5rem; /* px-6 py-3 */
            background-color: #10b981; /* bg-green-600 */
            color: #ffffff; /* text-white */
            font-weight: 600; /* font-semibold */
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.2s ease-in-out; /* hover:bg-green-700 transition-colors duration-200 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .button-primary:hover {
            background-color: #059669; /* hover:bg-green-700 */
        }
        .button-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .button-secondary {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem; /* px-4 py-2 */
            background-color: #3b82f6; /* bg-blue-600 */
            color: #ffffff; /* text-white */
            border-radius: 0.375rem; /* rounded-md */
            transition: background-color 0.2s ease-in-out; /* hover:bg-blue-700 transition-colors duration-200 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
        }
        .button-secondary:hover {
            background-color: #2563eb; /* hover:bg-blue-700 */
        }
        .button-secondary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .output-panel {
            margin-top: 2rem; /* mt-8 */
            padding: 1.5rem; /* p-6 */
            background-color: #f9fafb; /* bg-gray-50 */
            border-radius: 0.5rem; /* rounded-lg */
            border: 1px solid #e5e7eb; /* border border-gray-200 */
        }
        .error-message {
            background-color: #fee2e2; /* bg-red-100 */
            border: 1px solid #f87171; /* border border-red-400 */
            color: #b91c1c; /* text-red-700 */
            padding: 0.75rem 1rem; /* px-4 py-3 */
            border-radius: 0.375rem; /* rounded-md */
            margin-bottom: 1rem; /* mb-4 */
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        /* Icon styling (for lucide-react equivalents) */
        .icon {
            width: 1.25rem; /* w-5 */
            height: 1.25rem; /* h-5 */
            margin-right: 0.5rem; /* mr-2 */
            vertical-align: middle;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 p-4 sm:p-6 lg:p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-4xl font-extrabold text-center text-blue-800 mb-8 tracking-tight">
            Performance Drafting Assistant
        </h1>

        <nav class="mb-8 bg-white p-4 rounded-lg shadow-md">
            <ul class="flex flex-wrap justify-center gap-4">
                <li>
                    <button id="nav-smartGoal" class="px-5 py-2 rounded-full text-sm font-medium transition-all duration-300 ease-in-out bg-blue-600 text-white shadow-lg">
                        SMART Goals
                    </button>
                </li>
                <li>
                    <button id="nav-performanceAppraisal" class="px-5 py-2 rounded-full text-sm font-medium transition-all duration-300 ease-in-out bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700">
                        Appraisal Feedback
                    </button>
                </li>
                <li>
                    <button id="nav-performanceNote" class="px-5 py-2 rounded-full text-sm font-medium transition-all duration-300 ease-in-out bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700">
                        Performance Notes
                    </button>
                </li>
                <li>
                    <button id="nav-idp" class="px-5 py-2 rounded-full text-sm font-medium transition-all duration-300 ease-in-out bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700">
                        IDP
                    </button>
                </li>
            </ul>
        </nav>

        <main id="app-content">
            <!-- Module content will be loaded here -->
        </main>
    </div>

    <script>
        // Icon SVGs (replacing lucide-react)
        const copyIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2v2"/></svg>`;
        const checkIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon"><path d="M20 6 9 17l-5-5"/></svg>`;
        const loaderIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon spinner"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>`;

        // Helper function to call the Gemini API
        async function callGeminiApi(prompt, schema = null) {
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = { contents: chatHistory };
            if (schema) {
                payload.generationConfig = {
                    responseMimeType: "application/json",
                    responseSchema: schema
                };
            }

            const apiKey = "AIzaSyD0oj9l40Pp94gRPAaGrc0xmg9lBWcmiEg"; // User's API key
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    // For structured output, we expect JSON, so parse it. Otherwise, return plain text.
                    return schema ? JSON.parse(text) : text;
                } else {
                    console.error("Unexpected API response structure:", result);
                    return "Error: Could not generate response. Please try again.";
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return `Error: Failed to connect to the AI model. ${error.message}`;
            }
        }

        // Reusable Copy to Clipboard Component (as a function that returns HTML)
        function createCopyButton(textToCopy, id) {
            const button = document.createElement('button');
            button.className = 'button-secondary';
            button.innerHTML = `${copyIcon} <span>Copy to Clipboard</span>`;
            button.id = id;
            button.disabled = !textToCopy;

            button.onclick = () => {
                if (textToCopy) {
                    const textarea = document.createElement('textarea');
                    textarea.value = textToCopy;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        button.innerHTML = `${checkIcon} <span>Copied!</span>`;
                        setTimeout(() => {
                            button.innerHTML = `${copyIcon} <span>Copy to Clipboard</span>`;
                        }, 2000);
                    } catch (err) {
                        console.error('Failed to copy text: ', err);
                        // Using a simple div for message instead of alert
                        const messageBox = document.createElement('div');
                        messageBox.className = 'fixed bottom-4 right-4 bg-red-600 text-white p-3 rounded-md shadow-lg';
                        messageBox.textContent = 'Failed to copy text. Please copy manually.';
                        document.body.appendChild(messageBox);
                        setTimeout(() => {
                            document.body.removeChild(messageBox);
                        }, 3000);
                    }
                    document.body.removeChild(textarea);
                }
            };
            return button;
        }

        // Function to display error messages
        function displayError(containerId, message) {
            const container = document.getElementById(containerId);
            let errorDiv = container.querySelector('.error-message');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                container.prepend(errorDiv);
            }
            errorDiv.innerHTML = `<span class="block sm:inline">${message}</span>`;
            errorDiv.style.display = message ? 'block' : 'none';
        }

        // Module 1: SMART Goal Drafting
        function renderSmartGoalDrafting() {
            const contentDiv = document.createElement('div');
            contentDiv.className = 'module-container';
            contentDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-6 text-gray-800">SMART Goal Drafting</h2>
                <div id="smart-goal-error-container"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="goalName" class="label-text">Goal Name <span class="text-red-500">*</span></label>
                        <input type="text" id="goalName" class="input-field" placeholder="e.g., Increase customer satisfaction" required>
                    </div>
                    <div>
                        <label for="targetKpi" class="label-text">Target/KPI <span class="text-red-500">*</span></label>
                        <input type="text" id="targetKpi" class="input-field" placeholder="e.g., NPS score by 10 points" required>
                    </div>
                    <div class="md:col-span-2">
                        <label for="deadline" class="label-text">Deadline <span class="text-red-500">*</span></label>
                        <input type="date" id="deadline" class="input-field" required>
                    </div>
                </div>
                <div class="flex items-center mb-6">
                    <input type="checkbox" id="generateSubtasks" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="generateSubtasks" class="ml-2 block text-sm font-medium text-gray-900">
                        Generate actionable subtasks
                    </label>
                </div>
                <button id="generateGoalBtn" class="button-primary">
                    ${loaderIcon} <span>Generate SMART Goal</span>
                </button>
                <div id="smart-goal-output" class="output-panel hidden">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Generated Drafts:</h3>
                    <div id="smart-goal-draft-section" class="mb-6">
                        <p id="smartGoalDraftText" class="text-gray-700 whitespace-pre-wrap"></p>
                        <div class="mt-4 flex justify-end" id="smartGoalCopyButtonContainer"></div>
                    </div>
                    <div id="subtasks-draft-section" class="hidden">
                        <h4 class="text-lg font-medium mb-2 text-gray-700">Suggested Subtasks:</h4>
                        <p id="subtasksDraftText" class="text-gray-700 whitespace-pre-wrap"></p>
                        <div class="mt-4 flex justify-end" id="subtasksCopyButtonContainer"></div>
                    </div>
                </div>
            `;
            document.getElementById('app-content').innerHTML = '';
            document.getElementById('app-content').appendChild(contentDiv);

            const goalNameInput = document.getElementById('goalName');
            const targetKpiInput = document.getElementById('targetKpi');
            const deadlineInput = document.getElementById('deadline');
            const generateSubtasksCheckbox = document.getElementById('generateSubtasks');
            const generateGoalBtn = document.getElementById('generateGoalBtn');
            const smartGoalOutputDiv = document.getElementById('smart-goal-output');
            const smartGoalDraftText = document.getElementById('smartGoalDraftText');
            const subtasksDraftSection = document.getElementById('subtasks-draft-section');
            const subtasksDraftText = document.getElementById('subtasksDraftText');
            const smartGoalCopyButtonContainer = document.getElementById('smartGoalCopyButtonContainer');
            const subtasksCopyButtonContainer = document.getElementById('subtasksCopyButtonContainer');
            const generateGoalBtnSpan = generateGoalBtn.querySelector('span');
            const generateGoalBtnIcon = generateGoalBtn.querySelector('svg');

            generateGoalBtn.onclick = async () => {
                displayError('smart-goal-error-container', ''); // Clear previous errors

                const goalName = goalNameInput.value.trim();
                const targetKpi = targetKpiInput.value.trim();
                const deadline = deadlineInput.value.trim();
                const generateSubtasks = generateSubtasksCheckbox.checked;

                if (!goalName || !targetKpi || !deadline) {
                    displayError('smart-goal-error-container', 'Please fill in all mandatory fields: Goal Name, Target/KPI, and Deadline.');
                    return;
                }

                generateGoalBtn.disabled = true;
                generateGoalBtnSpan.textContent = 'Generating...';
                generateGoalBtnIcon.style.display = 'inline-block'; // Show spinner

                smartGoalOutputDiv.classList.add('hidden');
                smartGoalDraftText.textContent = '';
                subtasksDraftText.textContent = '';
                subtasksDraftSection.classList.add('hidden');
                smartGoalCopyButtonContainer.innerHTML = '';
                subtasksCopyButtonContainer.innerHTML = '';

                const goalPrompt = `Draft a SMART goal (Specific, Measurable, Achievable, Relevant, Time-bound) based on the following:
    Goal Name: ${goalName}
    Target/KPI: ${targetKpi}
    Deadline: ${deadline}
    Ensure the output is a single, concise SMART goal statement.`;

                try {
                    const goalResponse = await callGeminiApi(goalPrompt);
                    smartGoalDraftText.textContent = goalResponse;
                    smartGoalOutputDiv.classList.remove('hidden');
                    smartGoalCopyButtonContainer.appendChild(createCopyButton(goalResponse, 'copy-smart-goal'));

                    if (generateSubtasks) {
                        const subtaskPrompt = `Given the SMART goal: "${goalResponse}", suggest a list of actionable subtasks to achieve it. Format as a numbered list.`;
                        const subtaskResponse = await callGeminiApi(subtaskPrompt);
                        subtasksDraftText.textContent = subtaskResponse;
                        subtasksDraftSection.classList.remove('hidden');
                        subtasksCopyButtonContainer.appendChild(createCopyButton(subtaskResponse, 'copy-subtasks'));
                    }
                } catch (err) {
                    displayError('smart-goal-error-container', `Failed to generate: ${err.message}`);
                } finally {
                    generateGoalBtn.disabled = false;
                    generateGoalBtnSpan.textContent = 'Generate SMART Goal';
                    generateGoalBtnIcon.style.display = 'none'; // Hide spinner
                }
            };
            generateGoalBtnIcon.style.display = 'none'; // Ensure spinner is hidden initially
        }

        // Module 2: Performance Appraisal Feedback
        function renderPerformanceAppraisalFeedback() {
            const contentDiv = document.createElement('div');
            contentDiv.className = 'module-container';
            contentDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Performance Appraisal Feedback</h2>
                <div id="appraisal-error-container"></div>
                <div class="mb-6">
                    <label class="label-text">Select Performance Tier <span class="text-red-500">*</span></label>
                    <div class="flex flex-wrap gap-4" id="performanceTierRadios">
                        <!-- Radio buttons will be inserted here -->
                    </div>
                </div>
                <div id="tierInputsContainer" class="mb-6 p-4 border border-gray-200 rounded-md bg-gray-50 hidden">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800" id="tierInputsTitle"></h3>
                    <!-- Tier-specific inputs will be rendered here -->
                </div>
                <button id="generateFeedbackBtn" class="button-primary" disabled>
                    ${loaderIcon} <span>Generate Feedback</span>
                </button>
                <div id="feedback-output" class="output-panel hidden">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Generated Feedback:</h3>
                    <p id="feedbackDraftText" class="text-gray-700 whitespace-pre-wrap"></p>
                    <div class="mt-4 flex justify-end" id="feedbackCopyButtonContainer"></div>
                </div>
            `;
            document.getElementById('app-content').innerHTML = '';
            document.getElementById('app-content').appendChild(contentDiv);

            const performanceTierRadios = document.getElementById('performanceTierRadios');
            const tierInputsContainer = document.getElementById('tierInputsContainer');
            const tierInputsTitle = document.getElementById('tierInputsTitle');
            const generateFeedbackBtn = document.getElementById('generateFeedbackBtn');
            const feedbackOutputDiv = document.getElementById('feedback-output');
            const feedbackDraftText = document.getElementById('feedbackDraftText');
            const feedbackCopyButtonContainer = document.getElementById('feedbackCopyButtonContainer');
            const generateFeedbackBtnSpan = generateFeedbackBtn.querySelector('span');
            const generateFeedbackBtnIcon = generateFeedbackBtn.querySelector('svg');

            let currentPerformanceTier = '';
            let currentInputs = {};

            const tiers = ['Poor Performance', 'Below Expectation', 'Meet Expectation', 'Exceed Expectation', 'Outstanding'];

            tiers.forEach(tier => {
                const label = document.createElement('label');
                label.className = 'inline-flex items-center cursor-pointer';
                label.innerHTML = `
                    <input type="radio" name="performanceTier" value="${tier}" class="form-radio h-4 w-4 text-blue-600 transition-colors duration-200">
                    <span class="ml-2 text-gray-900">${tier}</span>
                `;
                label.querySelector('input').addEventListener('change', (e) => {
                    currentPerformanceTier = e.target.value;
                    currentInputs = {}; // Reset inputs
                    feedbackDraftText.textContent = ''; // Clear previous draft
                    feedbackOutputDiv.classList.add('hidden');
                    displayError('appraisal-error-container', ''); // Clear errors
                    renderTierSpecificInputs();
                    generateFeedbackBtn.disabled = false; // Enable button once a tier is selected
                });
                performanceTierRadios.appendChild(label);
            });

            function renderTierSpecificInputs() {
                tierInputsContainer.classList.remove('hidden');
                tierInputsTitle.textContent = `Inputs for ${currentPerformanceTier}:`;
                tierInputsContainer.innerHTML = `<h3 class="text-lg font-semibold mb-3 text-gray-800">Inputs for ${currentPerformanceTier}:</h3>`; // Reset content

                let inputsHtml = '';
                switch (currentPerformanceTier) {
                    case 'Poor Performance':
                        inputsHtml = `
                            <div class="mb-4">
                                <label for="gaps" class="label-text">Gaps/Behavior/Incident <span class="text-red-500">*</span></label>
                                <textarea id="gaps" name="gaps" rows="3" class="textarea-field" placeholder="Describe specific gaps, behaviors, or incidents." required></textarea>
                            </div>
                            <div class="mb-4">
                                <label for="businessImpact" class="label-text">Business Impact <span class="text-red-500">*</span></label>
                                <textarea id="businessImpact" name="businessImpact" rows="3" class="textarea-field" placeholder="Explain the impact on business, team, or projects." required></textarea>
                            </div>
                        `;
                        break;
                    case 'Below Expectation':
                        inputsHtml = `
                            <div class="mb-4">
                                <label for="unmetGoals" class="label-text">Unmet Goals/Gaps <span class="text-red-500">*</span></label>
                                <textarea id="unmetGoals" name="unmetGoals" rows="3" class="textarea-field" placeholder="Detail goals that were not met or areas needing improvement." required></textarea>
                            </div>
                            <div class="mb-4">
                                <label for="businessImpact" class="label-text">Business Impact <span class="text-red-500">*</span></label>
                                <textarea id="businessImpact" name="businessImpact" rows="3" class="textarea-field" placeholder="Explain the impact of not meeting expectations." required></textarea>
                            </div>
                        `;
                        break;
                    case 'Meet Expectation':
                        inputsHtml = `
                            <div class="mb-4">
                                <label for="accomplishedResponsibilities" class="label-text">Accomplished Responsibilities <span class="text-red-500">*</span></label>
                                <textarea id="accomplishedResponsibilities" name="accomplishedResponsibilities" rows="3" class="textarea-field" placeholder="List key responsibilities and how they were met." required></textarea>
                            </div>
                        `;
                        break;
                    case 'Exceed Expectation':
                        inputsHtml = `
                            <div class="mb-4">
                                <label for="coreResponsibilities" class="label-text">Core Responsibilities <span class="text-red-500">*</span></label>
                                <textarea id="coreResponsibilities" name="coreResponsibilities" rows="3" class="textarea-field" placeholder="Describe how core responsibilities were handled exceptionally." required></textarea>
                            </div>
                            <div class="mb-4">
                                <label for="additionalResponsibilities" class="label-text">Additional Responsibilities <span class="text-red-500">*</span></label>
                                <textarea id="additionalResponsibilities" name="additionalResponsibilities" rows="3" class="textarea-field" placeholder="Detail extra tasks or projects taken on." required></textarea>
                            </div>
                            <div class="mb-4">
                                <label for="justificationAdditional" class="label-text">Justification for "Additional" <span class="text-red-500">*</span></label>
                                <textarea id="justificationAdditional" name="justificationAdditional" rows="3" class="textarea-field" placeholder="Explain why these additional responsibilities were significant." required></textarea>
                            </div>
                            <div class="mb-4">
                                <label for="achievementsImpact" class="label-text">Achievements Impact <span class="text-red-500">*</span></label>
                                <textarea id="achievementsImpact" name="achievementsImpact" rows="3" class="textarea-field" placeholder="Describe the overall impact of these achievements." required></textarea>
                            </div>
                        `;
                        break;
                    case 'Outstanding':
                        inputsHtml = `
                            <div class="mb-4">
                                <label for="outstandingSubOption" class="label-text">Outstanding Sub-option <span class="text-red-500">*</span></label>
                                <select id="outstandingSubOption" name="outstandingSubOption" class="select-field" required>
                                    <option value="">Select an option</option>
                                    <option value="Worked in Risk Areas">Worked in Risk Areas</option>
                                    <option value="Created Innovation">Created Innovation</option>
                                    <option value="Exceeded Target">Exceeded Target</option>
                                </select>
                            </div>
                            <div id="outstandingSubOptionInputs"></div>
                        `;
                        break;
                }
                tierInputsContainer.insertAdjacentHTML('beforeend', inputsHtml);

                // Attach event listeners to newly created inputs
                const textareas = tierInputsContainer.querySelectorAll('textarea, input, select');
                textareas.forEach(input => {
                    input.value = currentInputs[input.name] || ''; // Restore previous input value
                    input.addEventListener('input', (e) => {
                        currentInputs[e.target.name] = e.target.value;
                        if (e.target.name === 'outstandingSubOption') {
                            renderOutstandingSubOptionInputs(e.target.value);
                        }
                    });
                });

                if (currentPerformanceTier === 'Outstanding' && currentInputs.outstandingSubOption) {
                    renderOutstandingSubOptionInputs(currentInputs.outstandingSubOption);
                }
            }

            function renderOutstandingSubOptionInputs(subOption) {
                const subOptionInputsDiv = document.getElementById('outstandingSubOptionInputs');
                subOptionInputsDiv.innerHTML = ''; // Clear previous sub-option inputs

                let subOptionHtml = '';
                switch (subOption) {
                    case 'Worked in Risk Areas':
                        subOptionHtml = `
                            <div class="mb-4">
                                <label for="missionDetails" class="label-text">Mission Details (location, time, risk context) <span class="text-red-500">*</span></label>
                                <textarea id="missionDetails" name="missionDetails" rows="3" class="textarea-field" placeholder="Provide details about the mission, location, time, and risk context." required></textarea>
                            </div>
                        `;
                        break;
                    case 'Created Innovation':
                        subOptionHtml = `
                            <div class="mb-4">
                                <label for="solutionDescription" class="label-text">Solution Description <span class="text-red-500">*</span></label>
                                <textarea id="solutionDescription" name="solutionDescription" rows="3" class="textarea-field" placeholder="Describe the innovative solution created." required></textarea>
                            </div>
                            <div class="mb-4">
                                <label for="businessImpactMetrics" class="label-text">Business Impact Metrics <span class="text-red-500">*</span></label>
                                <textarea id="businessImpactMetrics" name="businessImpactMetrics" rows="3" class="textarea-field" placeholder="Quantify the business impact of the innovation (e.g., cost savings, revenue increase)." required></textarea>
                            </div>
                        `;
                        break;
                    case 'Exceeded Target':
                        subOptionHtml = `
                            <div class="mb-4">
                                <label for="targetSurpassMetrics" class="label-text">Target Surpass Metrics (quantitative) <span class="text-red-500">*</span></label>
                                <textarea id="targetSurpassMetrics" name="targetSurpassMetrics" rows="3" class="textarea-field" placeholder="Provide quantitative details on how targets were exceeded." required></textarea>
                            </div>
                            <div class="mb-4">
                                <label for="impact" class="label-text">Impact <span class="text-red-500">*</span></label>
                                <textarea id="impact" name="impact" rows="3" class="textarea-field" placeholder="Describe the impact of exceeding targets." required></textarea>
                            </div>
                        `;
                        break;
                }
                subOptionInputsDiv.insertAdjacentHTML('beforeend', subOptionHtml);

                // Attach event listeners to newly created sub-option inputs
                const subOptionTextareas = subOptionInputsDiv.querySelectorAll('textarea, input');
                subOptionTextareas.forEach(input => {
                    input.value = currentInputs[input.name] || ''; // Restore previous input value
                    input.addEventListener('input', (e) => {
                        currentInputs[e.target.name] = e.target.value;
                    });
                });
            }

            generateFeedbackBtn.onclick = async () => {
                displayError('appraisal-error-container', ''); // Clear previous errors
                generateFeedbackBtn.disabled = true;
                generateFeedbackBtnSpan.textContent = 'Generating...';
                generateFeedbackBtnIcon.style.display = 'inline-block'; // Show spinner

                feedbackOutputDiv.classList.add('hidden');
                feedbackDraftText.textContent = '';
                feedbackCopyButtonContainer.innerHTML = '';

                let prompt = '';
                let validationError = '';

                switch (currentPerformanceTier) {
                    case 'Poor Performance':
                        if (!currentInputs.gaps || !currentInputs.businessImpact) { validationError = 'Please provide Gaps/Behavior/Incident and Business Impact.'; }
                        prompt = `Draft constructive, improvement-focused feedback for poor performance.
                          Gaps/Behavior/Incident: ${currentInputs.gaps}
                          Business Impact: ${currentInputs.businessImpact}`;
                        break;
                    case 'Below Expectation':
                        if (!currentInputs.unmetGoals || !currentInputs.businessImpact) { validationError = 'Please provide Unmet Goals/Gaps and Business Impact.'; }
                        prompt = `Draft developmental feedback for below expectation performance.
                          Unmet Goals/Gaps: ${currentInputs.unmetGoals}
                          Business Impact: ${currentInputs.businessImpact}`;
                        break;
                    case 'Meet Expectation':
                        if (!currentInputs.accomplishedResponsibilities) { validationError = 'Please provide Accomplished Responsibilities.'; }
                        prompt = `Draft reinforcement-focused feedback for meeting expectations.
                          Accomplished Responsibilities: ${currentInputs.accomplishedResponsibilities}`;
                        break;
                    case 'Exceed Expectation':
                        if (!currentInputs.coreResponsibilities || !currentInputs.additionalResponsibilities || !currentInputs.justificationAdditional || !currentInputs.achievementsImpact) { validationError = 'Please provide Core Responsibilities, Additional Responsibilities, Justification for Additional, and Achievements Impact.'; }
                        prompt = `Draft achievement-highlighting feedback for exceeding expectations.
                          Core Responsibilities: ${currentInputs.coreResponsibilities}
                          Additional Responsibilities: ${currentInputs.additionalResponsibilities}
                          Justification for Additional: ${currentInputs.justificationAdditional}
                          Achievements Impact: ${currentInputs.achievementsImpact}`;
                        break;
                    case 'Outstanding':
                        switch (currentInputs.outstandingSubOption) {
                            case 'Worked in Risk Areas':
                                if (!currentInputs.missionDetails) { validationError = 'Please provide Mission Details.'; }
                                prompt = `Draft a risk-impact narrative for outstanding performance in risk areas.
                                  Mission Details (location, time, risk context): ${currentInputs.missionDetails}`;
                                break;
                            case 'Created Innovation':
                                if (!currentInputs.solutionDescription || !currentInputs.businessImpactMetrics) { validationError = 'Please provide Solution Description and Business Impact Metrics.'; }
                                prompt = `Draft an innovation-impact narrative for outstanding performance.
                                  Solution Description: ${currentInputs.solutionDescription}
                                  Business Impact Metrics: ${currentInputs.businessImpactMetrics}`;
                                break;
                            case 'Exceeded Target':
                                if (!currentInputs.targetSurpassMetrics || !currentInputs.impact) { validationError = 'Please provide Target Surpass Metrics and Impact.'; }
                                prompt = `Draft a quantitative achievement narrative for outstanding performance.
                                  Target Surpass Metrics: ${currentInputs.targetSurpassMetrics}
                                  Impact: ${currentInputs.impact}`;
                                break;
                            default:
                                validationError = 'Please select an outstanding sub-option.';
                        }
                        break;
                    default:
                        validationError = 'Please select a performance tier.';
                }

                if (validationError) {
                    displayError('appraisal-error-container', validationError);
                    generateFeedbackBtn.disabled = false;
                    generateFeedbackBtnSpan.textContent = 'Generate Feedback';
                    generateFeedbackBtnIcon.style.display = 'none'; // Hide spinner
                    return;
                }

                try {
                    const response = await callGeminiApi(prompt);
                    feedbackDraftText.textContent = response;
                    feedbackOutputDiv.classList.remove('hidden');
                    feedbackCopyButtonContainer.appendChild(createCopyButton(response, 'copy-feedback'));
                } catch (err) {
                    displayError('appraisal-error-container', `Failed to generate feedback: ${err.message}`);
                } finally {
                    generateFeedbackBtn.disabled = false;
                    generateFeedbackBtnSpan.textContent = 'Generate Feedback';
                    generateFeedbackBtnIcon.style.display = 'none'; // Hide spinner
                }
            };
            generateFeedbackBtnIcon.style.display = 'none'; // Ensure spinner is hidden initially
        }

        // Module 3: Performance Note Drafting
        function renderPerformanceNoteDrafting() {
            const contentDiv = document.createElement('div');
            contentDiv.className = 'module-container';
            contentDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Performance Note Drafting</h2>
                <div id="note-error-container"></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="dateOfObservation" class="label-text">Date of Observation <span class="text-red-500">*</span></label>
                        <input type="date" id="dateOfObservation" class="input-field" required>
                    </div>
                    <div>
                        <label for="feedbackType" class="label-text">Feedback Type <span class="text-red-500">*</span></label>
                        <select id="feedbackType" class="select-field" required>
                            <option value="">Select Type</option>
                            <option value="Recognition">Recognition</option>
                            <option value="Development">Development</option>
                            <option value="General">General</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label for="observedBehavior" class="label-text">Observed Behavior/Action <span class="text-red-500">*</span></label>
                        <textarea id="observedBehavior" rows="3" class="textarea-field" placeholder="Describe the specific behavior or action observed." required></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label for="contextSituation" class="label-text">Context/Situation <span class="text-red-500">*</span></label>
                        <textarea id="contextSituation" rows="3" class="textarea-field" placeholder="Explain the situation or context in which the behavior occurred." required></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label for="impactOutcome" class="label-text">Impact/Outcome <span class="text-red-500">*</span></label>
                        <textarea id="impactOutcome" rows="3" class="textarea-field" placeholder="Describe the impact or outcome of the behavior/action." required></textarea>
                        <div class="mt-2">
                            <label for="sentiment" class="label-text">Sentiment Indicator <span class="text-red-500">*</span></label>
                            <select id="sentiment" class="select-field" required>
                                <option value="">Select Sentiment</option>
                                <option value="Positive">Positive (+)</option>
                                <option value="Negative">Negative (-)</option>
                                <option value="Neutral">Neutral</option>
                            </select>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <label for="alignment" class="label-text">Alignment with Goals/Values (Optional)</label>
                        <textarea id="alignment" rows="2" class="textarea-field" placeholder="How does this align with company goals or values?"></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label for="nextSteps" class="label-text">Next Steps (Optional)</label>
                        <textarea id="nextSteps" rows="2" class="textarea-field" placeholder="What are the agreed-upon next steps or actions?"></textarea>
                    </div>
                </div>
                <button id="generateNoteBtn" class="button-primary">
                    ${loaderIcon} <span>Generate Performance Note</span>
                </button>
                <div id="note-output" class="output-panel hidden">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Generated Performance Note:</h3>
                    <p id="noteDraftText" class="text-gray-700 whitespace-pre-wrap"></p>
                    <div class="mt-4 flex justify-end" id="noteCopyButtonContainer"></div>
                </div>
            `;
            document.getElementById('app-content').innerHTML = '';
            document.getElementById('app-content').appendChild(contentDiv);

            const dateOfObservationInput = document.getElementById('dateOfObservation');
            const observedBehaviorInput = document.getElementById('observedBehavior');
            const contextSituationInput = document.getElementById('contextSituation');
            const impactOutcomeInput = document.getElementById('impactOutcome');
            const sentimentSelect = document.getElementById('sentiment');
            const alignmentInput = document.getElementById('alignment');
            const feedbackTypeSelect = document.getElementById('feedbackType');
            const nextStepsInput = document.getElementById('nextSteps');
            const generateNoteBtn = document.getElementById('generateNoteBtn');
            const noteOutputDiv = document.getElementById('note-output');
            const noteDraftText = document.getElementById('noteDraftText');
            const noteCopyButtonContainer = document.getElementById('noteCopyButtonContainer');
            const generateNoteBtnSpan = generateNoteBtn.querySelector('span');
            const generateNoteBtnIcon = generateNoteBtn.querySelector('svg');

            generateNoteBtn.onclick = async () => {
                displayError('note-error-container', ''); // Clear previous errors

                const dateOfObservation = dateOfObservationInput.value.trim();
                const observedBehavior = observedBehaviorInput.value.trim();
                const contextSituation = contextSituationInput.value.trim();
                const impactOutcome = impactOutcomeInput.value.trim();
                const sentiment = sentimentSelect.value;
                const alignment = alignmentInput.value.trim();
                const feedbackType = feedbackTypeSelect.value;
                const nextSteps = nextStepsInput.value.trim();

                if (!dateOfObservation || !observedBehavior || !contextSituation || !impactOutcome || !sentiment || !feedbackType) {
                    displayError('note-error-container', 'Please fill in all mandatory fields.');
                    return;
                }

                generateNoteBtn.disabled = true;
                generateNoteBtnSpan.textContent = 'Generating...';
                generateNoteBtnIcon.style.display = 'inline-block'; // Show spinner

                noteOutputDiv.classList.add('hidden');
                noteDraftText.textContent = '';
                noteCopyButtonContainer.innerHTML = '';

                const prompt = `Draft a professional performance note based on the following details:
                Date of Observation: ${dateOfObservation}
                Observed Behavior/Action: ${observedBehavior}
                Context/Situation: ${contextSituation}
                Impact/Outcome: ${impactOutcome} (Sentiment: ${sentiment})
                Feedback Type: ${feedbackType}
                ${alignment ? `Alignment with Goals/Values: ${alignment}` : ''}
                ${nextSteps ? `Next Steps: ${nextSteps}` : ''}
                Ensure the note is a coherent narrative, professionally formatted, and adheres to HR best practices.`;

                try {
                    const response = await callGeminiApi(prompt);
                    noteDraftText.textContent = response;
                    noteOutputDiv.classList.remove('hidden');
                    noteCopyButtonContainer.appendChild(createCopyButton(response, 'copy-note'));
                } catch (err) {
                    displayError('note-error-container', `Failed to generate note: ${err.message}`);
                } finally {
                    generateNoteBtn.disabled = false;
                    generateNoteBtnSpan.textContent = 'Generate Performance Note';
                    generateNoteBtnIcon.style.display = 'none'; // Hide spinner
                }
            };
            generateNoteBtnIcon.style.display = 'none'; // Ensure spinner is hidden initially
        }

        // Module 4: Individual Development Plan (IDP) Module
        function renderIdpModule() {
            const contentDiv = document.createElement('div');
            contentDiv.className = 'module-container';
            contentDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Individual Development Plan (IDP) Module</h2>
                <div id="idp-error-container"></div>
                <div class="mb-6">
                    <label for="targetSkill" class="label-text">Development Target Skill/Competency/Goal <span class="text-red-500">*</span></label>
                    <textarea id="targetSkill" rows="2" class="textarea-field" placeholder="e.g., Improve leadership communication skills" required></textarea>
                </div>

                <div class="mb-6 p-4 border border-gray-200 rounded-md bg-gray-50">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">Development Activities:</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="trainingCourses" class="label-text">Training/Courses</label>
                            <textarea id="trainingCourses" rows="2" class="textarea-field" placeholder="e.g., 'Effective Communication' online course"></textarea>
                        </div>
                        <div>
                            <label for="workshopsCertifications" class="label-text">Workshops/Certifications</label>
                            <textarea id="workshopsCertifications" rows="2" class="textarea-field" placeholder="e.g., 'Certified Leadership Coach' workshop"></textarea>
                        </div>
                        <div>
                            <label for="jobShadowingMentoring" class="label-text">Job Shadowing/Mentoring</label>
                            <textarea id="jobShadowingMentoring" rows="2" class="textarea-field" placeholder="e.g., Shadowing senior manager in client meetings"></textarea>
                        </div>
                        <div>
                            <label for="stretchAssignments" class="label-text">Stretch Assignments</label>
                            <textarea id="stretchAssignments" rows="2" class="textarea-field" placeholder="e.g., Lead cross-functional project team"></textarea>
                        </div>
                        <div>
                            <label for="researchTopics" class="label-text">Research Topics</label>
                            <textarea id="researchTopics" rows="2" class="textarea-field" placeholder="e.g., Best practices in remote team communication"></textarea>
                        </div>
                        <div>
                            <label for="networking" class="label-text">Networking</label>
                            <textarea id="networking" rows="2" class="textarea-field" placeholder="e.g., Connect with industry leaders on LinkedIn"></textarea>
                        </div>
                    </div>
                </div>

                <div class="mb-6 p-4 border border-gray-200 rounded-md bg-gray-50">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800">Support & Resources:</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="managerOrgSupport" class="label-text">Manager/Org Support Required</label>
                            <textarea id="managerOrgSupport" rows="2" class="textarea-field" placeholder="e.g., Regular 1:1s, access to leadership training"></textarea>
                        </div>
                        <div>
                            <label for="budgetTimeEstimates" class="label-text">Budget/Time Estimates</label>
                            <textarea id="budgetTimeEstimates" rows="2" class="textarea-field" placeholder="e.g., $500 for course, 2 hours/week dedicated time"></textarea>
                        </div>
                        <div class="md:col-span-2">
                            <label for="toolsSystemsNeeded" class="label-text">Tools/Systems Needed</label>
                            <textarea id="toolsSystemsNeeded" rows="2" class="textarea-field" placeholder="e.g., Access to LinkedIn Learning, project management software"></textarea>
                        </div>
                    </div>
                </div>

                <button id="generateIdpBtn" class="button-primary">
                    ${loaderIcon} <span>Generate IDP Document</span>
                </button>
                <div id="idp-output" class="output-panel hidden">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Generated IDP Document:</h3>
                    <p id="idpDocumentText" class="text-gray-700 whitespace-pre-wrap"></p>
                    <div class="mt-4 flex justify-end" id="idpCopyButtonContainer"></div>
                </div>
            `;
            document.getElementById('app-content').innerHTML = '';
            document.getElementById('app-content').appendChild(contentDiv);

            const targetSkillInput = document.getElementById('targetSkill');
            const trainingCoursesInput = document.getElementById('trainingCourses');
            const workshopsCertificationsInput = document.getElementById('workshopsCertifications');
            const jobShadowingMentoringInput = document.getElementById('jobShadowingMentoring');
            const stretchAssignmentsInput = document.getElementById('stretchAssignments');
            const researchTopicsInput = document.getElementById('researchTopics');
            const networkingInput = document.getElementById('networking');
            const managerOrgSupportInput = document.getElementById('managerOrgSupport');
            const budgetTimeEstimatesInput = document.getElementById('budgetTimeEstimates');
            const toolsSystemsNeededInput = document.getElementById('toolsSystemsNeeded');
            const generateIdpBtn = document.getElementById('generateIdpBtn');
            const idpOutputDiv = document.getElementById('idp-output');
            const idpDocumentText = document.getElementById('idpDocumentText');
            const idpCopyButtonContainer = document.getElementById('idpCopyButtonContainer');
            const generateIdpBtnSpan = generateIdpBtn.querySelector('span');
            const generateIdpBtnIcon = generateIdpBtn.querySelector('svg');

            generateIdpBtn.onclick = async () => {
                displayError('idp-error-container', ''); // Clear previous errors

                const targetSkill = targetSkillInput.value.trim();
                const trainingCourses = trainingCoursesInput.value.trim();
                const workshopsCertifications = workshopsCertificationsInput.value.trim();
                const jobShadowingMentoring = jobShadowingMentoringInput.value.trim();
                const stretchAssignments = stretchAssignmentsInput.value.trim();
                const researchTopics = researchTopicsInput.value.trim();
                const networking = networkingInput.value.trim();
                const managerOrgSupport = managerOrgSupportInput.value.trim();
                const budgetTimeEstimates = budgetTimeEstimatesInput.value.trim();
                const toolsSystemsNeeded = toolsSystemsNeededInput.value.trim();

                if (!targetSkill) {
                    displayError('idp-error-container', 'Please provide a Development Target Skill/Competency/Goal.');
                    return;
                }

                generateIdpBtn.disabled = true;
                generateIdpBtnSpan.textContent = 'Generating...';
                generateIdpBtnIcon.style.display = 'inline-block'; // Show spinner

                idpOutputDiv.classList.add('hidden');
                idpDocumentText.textContent = '';
                idpCopyButtonContainer.innerHTML = '';

                const prompt = `Generate a structured Individual Development Plan (IDP) document based on the following:

                Development Target: ${targetSkill}

                Development Activities:
                - Training/Courses: ${trainingCourses || 'N/A'}
                - Workshops/Certifications: ${workshopsCertifications || 'N/A'}
                - Job Shadowing/Mentoring: ${jobShadowingMentoring || 'N/A'}
                - Stretch Assignments: ${stretchAssignments || 'N/A'}
                - Research Topics: ${researchTopics || 'N/A'}
                - Networking: ${networking || 'N/A'}

                Support & Resources:
                - Manager/Org Support Required: ${managerOrgSupport || 'N/A'}
                - Budget/Time Estimates: ${budgetTimeEstimates || 'N/A'}
                - Tools/Systems Needed: ${toolsSystemsNeeded || 'N/A'}

                Format the output as a clear document with sections for "Development Target", "Activities", and "Support/Resources".`;

                try {
                    const response = await callGeminiApi(prompt);
                    idpDocumentText.textContent = response;
                    idpOutputDiv.classList.remove('hidden');
                    idpCopyButtonContainer.appendChild(createCopyButton(response, 'copy-idp'));
                } catch (err) {
                    displayError('idp-error-container', `Failed to generate IDP: ${err.message}`);
                } finally {
                    generateIdpBtn.disabled = false;
                    generateIdpBtnSpan.textContent = 'Generate IDP Document';
                    generateIdpBtnIcon.style.display = 'none'; // Hide spinner
                }
            };
            generateIdpBtnIcon.style.display = 'none'; // Ensure spinner is hidden initially
        }


        // Main application logic
        let activeModule = 'smartGoal'; // Default active module

        function setActiveModule(moduleId) {
            activeModule = moduleId;
            const navButtons = document.querySelectorAll('nav button');
            navButtons.forEach(button => {
                if (button.id === `nav-${moduleId}`) {
                    button.className = `px-5 py-2 rounded-full text-sm font-medium transition-all duration-300 ease-in-out bg-blue-600 text-white shadow-lg`;
                } else {
                    button.className = `px-5 py-2 rounded-full text-sm font-medium transition-all duration-300 ease-in-out bg-gray-200 text-gray-700 hover:bg-blue-100 hover:text-blue-700`;
                }
            });
            renderCurrentModule();
        }

        function renderCurrentModule() {
            switch (activeModule) {
                case 'smartGoal':
                    renderSmartGoalDrafting();
                    break;
                case 'performanceAppraisal':
                    renderPerformanceAppraisalFeedback();
                    break;
                case 'performanceNote':
                    renderPerformanceNoteDrafting();
                    break;
                case 'idp':
                    renderIdpModule();
                    break;
            }
        }

        // Attach event listeners to navigation buttons
        document.getElementById('nav-smartGoal').addEventListener('click', () => setActiveModule('smartGoal'));
        document.getElementById('nav-performanceAppraisal').addEventListener('click', () => setActiveModule('performanceAppraisal'));
        document.getElementById('nav-performanceNote').addEventListener('click', () => setActiveModule('performanceNote'));
        document.getElementById('nav-idp').addEventListener('click', () => setActiveModule('idp'));

        // Initial render
        document.addEventListener('DOMContentLoaded', renderCurrentModule);
    </script>
</body>
</html>
